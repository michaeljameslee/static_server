(function(){var u=window.$MicrosoftMaps8,i=u.Internal,ei=u.Anchor,g=Microsoft.Maps.Internal._BaseMapDataSource,o=i._BaseMapTemplateSelector,nt=i.CanvasDrawingContext,l=u.CoordinateProjection,f=i._Debug,e=i._EntityHelper,oi=u.G,at=u.GlobalConfig,si=i._Gimme,t=i._Helper,vt=i.HitTestIndex,s=i._JSEvent,h=at.features.labels,yt=i._LayerDataSource,hi=u.LocationRect,tt=i._MapFrameData,ci=u.Location,p=u.Matrix2D,li=i.MapHelper,pt=u.MapMath,ai=u.MapTypeId,wt=i._Observable,bt=i._ObservableObject,r=u.Point,c=u.Rectangle,it=i.RegionIndex,vi=u.SimplePointPrimitive,b=u.Size,kt=u.Viewport,k=u.ZoomLevel,yi=i.Iterator,pi=i._Network,dt=i._LatLonCrs,rt=i._NAARectangle,gt=u.VectorImageTemplate,wi=u.VectorMapLayer,ut=i._VectorMath,bi=i._WorkDispatcher,d=function(){function n(){}return n.getKey=function(n,t){var i=n.geometryType,f="b:"+(t.bucket||"-1"),e="r:"+(n.revision||0),o="l:"+(n.layer&&n.layer.getId()||"0"),r="g:"+i+"#"+f+"#"+e+"#"+o,u=(t.iconText||"")+(t.text||"");return t.type===4?"#S#"+t.shieldIndex+"#"+u:i===2?r+"#"+u:r+"#"+t.entityId},n}(),ft=function(){function n(n,t){this.bbox=c.empty();this.setAnchor(n);this.bounds=[];t&&this.add(t)}return n.prototype.add=function(n){this.bounds.push(n);this.bbox.union(n.bbox);this._refreshArbb()},n.prototype.getBoundingBoxRelativeTo=function(n){var t=this.anchorRelativeBoundingBox;return n&&!t.isEmpty()&&(t=new c(t.minPoint.add(n),t.maxPoint.add(n))),t},n.prototype.setAnchor=function(n){this.anchor=n&&n.clone();this._refreshArbb()},n.prototype._refreshArbb=function(){var n=this.anchor;this.anchorRelativeBoundingBox=n&&!this.bbox.isEmpty()?new c(this.bbox.minPoint.subtract(n),this.bbox.maxPoint.subtract(n)):c.empty()},n.prototype.intersects=function(n){var t,r,u,i,f,e;if(!this.bbox.intersects(n.bbox))return!1;for(t=0,r=this.bounds.length;t<r;t++)for(u=this.bounds[t],i=0,f=n.bounds.length;i<f;i++)if(e=n.bounds[i],u.intersects(e))return!0;return!1},n}(),v=function(){function t(n){this.data=n;this._padding=t._defaultPadding;this.id=n.labelId;this.lastUsedRegions=[];this.reset()}return t.prototype.reset=function(){this.placedRegions=[];this.placementPriority=Number.MAX_VALUE;this.shouldBeRendered=!0;this.regions=[];this.positionInitialized=!1},t.getIconBounds=function(n,t,i){var u=c.empty(),r,f;if(n)for(r=0,f=n.length;r<f;r++)u.union(n[r].getBounds(t,i));return u},t.prototype.lastUsedRegion=function(n){for(var r,i=0,u=this.lastUsedRegions.length;i<u;i++)if(r=this.lastUsedRegions[i],t._regionsMatch(r,n))return r;return n},t._regionsMatch=function(n,t){var i=n.bounds.getBoundingBoxRelativeTo(n.anchor),r=t.bounds.getBoundingBoxRelativeTo(t.anchor);return i.equals(r,.5)},t.prototype.initializePosition=function(n,t){var i,r;this.positionInitialized||(this._initializeLabelRegions(n,t),i=this.data.style&&this.data.style.styleStatic.strataStyle,i&&i.alpha&&i.alpha<w.collisionAlphaThreshold&&this.regions.length&&(r=this.regions[0],r.isFixed=!0),this._initBounds(n),this.positionInitialized=!0)},t.prototype._computeFontSize=function(n,t,i,r,u){var f=n/t,e=i/f;return pt.roundToInterval(Math.min(r,e)/u,.1)},t.getLabelOrigin=function(t,i,u,f){var e,o;f=f||n.topRight;u=u||{x:0,y:0};switch(f&n.horizontalMask){case n.left:e=-t;break;case n.center:e=-t/2;break;default:case n.right:e=0}switch(f&n.verticalMask){default:case n.top:o=-i;break;case n.middle:o=-i/2;break;case n.bottom:o=0}return new r(e+u.x,o+u.y)},t.prototype._initBounds=function(n){for(var i,u,f,e=0,v=this.regions.length;e<v;e++)if(i=this.regions[e],n.normalize(i.anchor),i.anchorTransform=p.identity,i.bounds===undefined){u=i.size;u||(f||(f=this._measureLabel()),u=f);var s=u.height,h=u.width,y=i.anchor,o=t.getLabelOrigin(h,s,i.anchorOffset,i.placement),w=new r(o.x+h,o.y+s),l=new c(o,w),a=Math.max(this.data.lowImportanceCollisionPadding/4,this._padding)||this._padding;l.buffer(a,a);i.bounds=new ft(i.anchor,new rt(l,i.orientation,y))}},t.prototype.getRegions=function(){if(!this.positionInitialized)throw"Invalid operation: initializePosition must be called before getRegions";return this.regions},t.prototype._measureLabel=function(){this.lineWidths=[];var n=this.data;return ct.getTextSize(n.text,n.secondaryText,n.style,n.fontSize,n.secondaryFontSize,this.lineWidths)},t.prototype._hasBackground=function(){var n=this.data.style.styleStatic;return n.showBackground&&!!(n.backgroundColor||n.backgroundOutlineColor&&n.backgroundOutlineWidth)},t.prototype._initializeLabelRegions=function(){},t.prototype._getRegionsFromHints=function(i,u,f,e,o){for(var it,h,rt,v,k,ct,g,s,nt,ft,et,y,lt,w,at,ot,st=[],ht={},b=[],tt=0,vt=this.data.primitives.length;tt<vt;tt++)if(it=this.data.primitives[tt],h=it.entity.labelHint,h&&h.lbl&&st.indexOf(h)===-1){for(rt=0,v=null,k=0,ct=h.lbl.length;k<ct;k++){var ut=h.lbl[k],d=[],yt=ut.tps&&ut.tps.length,c=f,a=null;for(g=0;g<yt;g++)s=ut.tps[g],a||(nt=new l(it.crs,i),nt.project(s.x,s.y),a=new r(nt.lastProjectedX,nt.lastProjectedY),i.normalize(a),c||(ft=a.x,et=a.y,s.n&&(y=new r(s.w/2,s.h/2),s.a&&(lt=p.identity.rotate(s.a),y=lt.transform(y)),ft+=y.x,et+=y.y),c=new r(ft,et))),d.push(s);w=d[0];at=this.data.text&&this.data.text.split("\n")[0];rt===0||w.n===at||!w.n&&e?(ot=(w.n||"")+c.x.toFixed(2)+","+c.y.toFixed(2),ht[ot]||(ht[ot]=!0,v={label:this,text:this.data.text,anchor:c.clone(),anchorOffset:new r(a.x-c.x,a.y-c.y),parentRegion:o,textSpans:d,placement:w.n?undefined:n.middleCenter},b.push(v))):v&&Array.prototype.push.apply(v.textSpans,d);rt++}st.push(h)}return b.length>1&&this._setReplicaProximityForLabelHints(),t._computeRegionBoundsBasedOnLabelHints(b),b},t.prototype._setReplicaProximityForLabelHints=function(){this.replicaProximity=1},t._computeRegionBoundsBasedOnLabelHints=function(n){for(var t,f,h,i,o,l,u=0,s=n.length;u<s;u++)if(t=n[u],t.textSpans){var e=new ft(t.anchor),a=t.textSpans[0].x,v=t.textSpans[0].y;for(f=0,h=t.textSpans.length;f<h;f++)i=t.textSpans[f],i.n&&(o=new b(i.w,i.h),l=new r(t.anchor.x+t.anchorOffset.x+(i.x-a),t.anchor.y+t.anchorOffset.y+(i.y-v)),e.add(new rt(new c(new r(0,0),new r(o.width,o.height)),i.a,l)));e.bbox.isEmpty()||(t.bounds=e)}},t._defaultPadding=2,t}(),a=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),y=function(t){function i(n){return t.call(this,n)||this}return a(i,t),i.prototype._initializeLabelRegions=function(n){var t=new l(this.data.crs,n),o=this.data.primitives[0],s=o.entity.labelHint,i,r,u,f,e;s?(i=s.lbl,r=i[0],i&&i.length>0&&r.tps&&r.tps.length>0&&(u=r.tps[0],t.project(u.x,u.y))):(f=o.geometry,t.project(f.x,f.y));e=this._getIconRegion(t.lastProjectedX,t.lastProjectedY);e&&this.regions.push(e)},i.prototype._getIconRegion=function(t,u){var o,s=this.data.iconTemplates,f=this.data.imageWidth,e=this.data.imageHeight,c,h;if((!f||!e)&&s&&s[0]){var y=this.data.primitives[0].stretchText!==!1,p=v.getIconBounds(s,this.data.iconText,y),l=p.getSize(),a=s[0].getAnchorPoint(this.data.iconText);f=l.width;e=l.height;c=new r(f/2-a.x,e/2-a.y)}return f&&e&&(o={type:1,label:this,text:this.data.iconText,anchor:new r(t,u),anchorOffset:c,size:new b(f,e),placement:n.middleCenter},h=this.data.primitives[0].entity.collisionBehavior||0,h!==0&&(o.isFixed=!0),h===2&&(o.occludesOthers=!0),this.data.offsetX||(this.data.offsetX=f/2+i._defaultIconLabelOffset),this.data.offsetY||(this.data.offsetY=e/2+i._defaultIconLabelOffset)),o},i._defaultIconLabelOffset=2,i}(v),n;(function(n){n[n.none=0]="none";n[n.top=1]="top";n[n.middle=2]="middle";n[n.bottom=4]="bottom";n[n.verticalMask=15]="verticalMask";n[n.left=16]="left";n[n.center=32]="center";n[n.right=64]="right";n[n.horizontalMask=240]="horizontalMask";n[n.topLeft=17]="topLeft";n[n.topCenter=33]="topCenter";n[n.topRight=65]="topRight";n[n.middleLeft=18]="middleLeft";n[n.middleCenter=34]="middleCenter";n[n.middleRight=66]="middleRight";n[n.bottomLeft=20]="bottomLeft";n[n.bottomCenter=36]="bottomCenter";n[n.bottomRight=68]="bottomRight"})(n||(n={}));var a=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),et=function(t){function i(n){var i=t.call(this,n)||this;return i._calculatePlacements(),i}return a(i,t),i.prototype._calculatePlacements=function(){this._placement=n.none;switch(this.data.pointType){default:this._possiblePlacements=i._defaultLabelPlacements;break;case 9:this._possiblePlacements=i._basemapIconLabelPlacements;break;case 1:case 2:case 8:this._possiblePlacements=i._poiLabelPlacements;this._hasBackground()||(this._padding=0);break;case 3:this._possiblePlacements=i._transientLensLabelTopPlacements;break;case 4:this._possiblePlacements=i._transientLensLabelBottomPlacements;break;case 5:this._possiblePlacements=i._transientLensLabelLeftPlacements;break;case 6:this._possiblePlacements=i._transientLensLabelRightPlacements}},i.prototype._getIconLocationFromHint=function(n){var i=n.entity.labelHint,t=g.getAnchorTextSpan(i);return t&&!t.n?new r(t.x,t.y):null},i.prototype._initializeLabelRegions=function(n,t){var s=this.data.primitives[0],i=this._getIconLocationFromHint(s),h=s.geometry,e=new l(this.data.crs,n),f,o,v;e.project(i?i.x:h.x,i?i.y:h.y);var c=e.lastProjectedX,a=e.lastProjectedY,u=this._getIconRegion(c,a);if(u&&this.regions.push(u),f=new r(c,a),n.normalize(f),o=this._getRegionsFromHints(n,t,f,!1,u),o.length){this._padding=0;Array.prototype.push.apply(this.regions,o);return}v=this._measureLabel();Array.prototype.push.apply(this.regions,this._getTextRegions(f,v,u))},i.prototype._getTextRegions=function(n,t,i){for(var u,f=[],e=this.data.offsetX||0,o=this.data.offsetY||0,r=0,s=this._possiblePlacements.length;r<s;r++)u=this._getRegionForPosition(this._possiblePlacements[r],t,n.x,n.y,e,o,i),u&&f.push(u);return f},i.prototype._getRegionForPosition=function(t,i,u,f,e,o,s){t=t||n.middleCenter;var v,p,w,b,l,a,k,d=i.width,g=i.height,c=s?s.label.data.primitives:null,h=c&&c.length>0&&c[0].getIcon&&!!c[0].getIcon(),rt=h?c[0].image.width:null,ut=h?c[0].image.height:null,tt=h?c[0].getAnchor().x:null,it=h?c[0].getAnchor().y:null,nt=h?y._defaultIconLabelOffset:this._padding;switch(t&n.horizontalMask){default:case n.center:l=0;v=u-d/2+l;p=v+d;k=0;break;case n.left:l=(h?-tt:-e)-2*nt;p=u+l;v=p-d;k=2;break;case n.right:l=(h?rt-tt:e)+2*nt;v=u+l;p=v+d;k=1}switch(t&n.verticalMask){default:case n.middle:a=0;w=f-g/2+a;b=f+g;break;case n.top:a=(h?-it:-o)-2*nt;b=f+o;w=b-g;break;case n.bottom:a=(h?ut-it:o)+nt;w=f+a;b=w+g}return{label:this,text:this.data.text,secondaryText:this.data.secondaryText,anchor:new r(u,f),anchorOffset:new r(l,a),placement:t,parentRegion:s,orientation:0,horizontalAlignment:k}},i._poiLabelPlacements=[n.bottomCenter,n.topCenter,n.middleLeft,n.middleRight],i._basemapIconLabelPlacements=[n.topLeft,n.topRight,n.bottomLeft,n.bottomRight,n.bottomCenter],i._transientLensLabelTopPlacements=[n.topCenter],i._transientLensLabelBottomPlacements=[n.bottomCenter],i._transientLensLabelLeftPlacements=[n.middleLeft],i._transientLensLabelRightPlacements=[n.middleRight],i._defaultLabelPlacements=[n.middleCenter],i}(y),a=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),ot=function(t){function i(n){return t.call(this,n)||this}return a(i,t),i.prototype._initializeLabelRegions=function(n,t){var e,f,a;if(this.regions=this._getRegionsFromHints(n,t),!this.regions.length)for(e=i.getLongestSegments(this.data.primitives,i._MAX_ALTERNATES),f=0,a=e.length;f<a;f++){var u=e[f],o=u.x0,s=u.y0,h=u.x1,c=u.y1,r=new l(u.crs,n);r.project(o,s);o=r.lastProjectedX;s=r.lastProjectedY;r.project(h,c);h=r.lastProjectedX;c=r.lastProjectedY;this._addLinearLabelRegion(o,s,h,c)}},i.prototype._addLinearLabelRegion=function(t,u,f,e){var o,s,h;t>f&&(o=t,t=f,f=o,o=u,u=e,e=o);s=Math.atan2(e-u,f-t);Math.abs(s-Math.PI/2)<=i._VERTICAL_LABEL_TOLERANCE&&(s+=Math.PI,h=t,t=f,f=h,h=u,u=e,e=h);this.regions.push({label:this,text:this.data.text,anchor:new r((t+f)/2,(u+e)/2),placement:n.middleCenter,horizontalAlignment:0,orientation:s})},i.getLongestSegments=function(n,t){for(var e,r,i,o,u=[],f=0,a=n.length;f<a;f++)for(e=n[f],r=e.geometry,i=0,o=r.x.length-1;i<o;i++){var s=r.x[i],h=r.y[i],c=r.x[i+1],l=r.y[i+1];u[f]={x0:s,y0:h,x1:c,y1:l,crs:e.crs,weight:Math.abs(s-c)+Math.abs(h-l)}}return u.sort(function(n,t){return t.weight-n.weight}),u.length=Math.min(u.length,t),u},i._MAX_ALTERNATES=3,i._VERTICAL_LABEL_TOLERANCE=Math.PI/60,i}(v),a=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),ni=function(t){function i(n){return t.call(this,n)||this}return a(i,t),i.prototype._largestAreaPrimitiveItem=function(n){for(var r=-1,u=0,t=0,e=n.length;t<e;t++){var i=n[t].geometry,o=Math.abs(i.bounds[1]-i.bounds[3]),s=Math.abs(i.bounds[2]-i.bounds[0]),f=o*s;f>r&&(r=f,u=t)}return u},i.prototype._initializeLabelRegions=function(t,u){var s,f,o,c,a;if(this.regions=this._getRegionsFromHints(t,u),!this.regions.length){s=0;this.data.primitives.length>1&&(s=this._largestAreaPrimitiveItem(this.data.primitives));f=new l(this.data.primitives[s].crs,t);o=this.data.primitives[s].geometry;f.project(o.bounds[3],o.bounds[2]);c=f.lastProjectedX;a=f.lastProjectedY;f.project(o.bounds[1],o.bounds[0]);var y=f.lastProjectedX,p=f.lastProjectedY,h=y-c,v=a-p,e=this._measureLabel();e.width/h>=i._MAX_LABEL_SIZE_TO_PRIMITIVE_SIZE_RATIO&&(this.data.text=w.wrapTextToFit(this.data.text,e,{width:h,height:v}),this.data.text.indexOf("\n")>0&&(e=this._measureLabel()));e.width/h>=i._MAX_LABEL_SIZE_TO_PRIMITIVE_SIZE_RATIO||e.height/v>=i._MAX_LABEL_SIZE_TO_PRIMITIVE_SIZE_RATIO||e.width*e.height/(h*v)>=i._MAX_LABEL_SIZE_TO_PRIMITIVE_SIZE_RATIO?this.shouldBeRendered=!1:this.regions.push({label:this,text:this.data.text,anchor:new r((c+y)/2,(a+p)/2),horizontalAlignment:0,placement:n.middleCenter,orientation:0})}},i._MAX_LABEL_SIZE_TO_PRIMITIVE_SIZE_RATIO=1.3,i._MAX_PRIMITIVE_HEIGHT_TO_LABEL_HEIGHT_RATIO=2.5,i._MAX_LABEL_TEXT_LENGTH=15,i}(v),a=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),ti=function(t){function i(n,r){var u=t.call(this,n)||this,f=i._roadShieldModifierStyle;switch(r){case"8CCEE531-6C9C-45AD-9F30-ACE9C310A8B6":case"7443EAC9-CD76-4236-B027-22DBC504BF06":f=i._aerialShieldModifierStyle}return u.data.style=f,u.data.fontSize=f.styleStatic.fontSize,u._possiblePlacements=i._roadShieldPlacements,u.replicaProximity=200,u}return a(i,t),i.prototype._initializeLabelRegions=function(t,u){var o=[],a,s,w,k,d,h,c,g,f;if(o=this._getRegionsFromHints(t,u,null,!0),!o.length)for(a=ot.getLongestSegments(this.data.primitives,i._MAX_REPLICAS),s=0,w=a.length;s<w;s++){var e=a[s],nt=e.x0,tt=e.y0,it=e.x1,rt=e.y1,b=new r((nt+it)/2,(tt+rt)/2),p=new l(e.crs,t);p.project(b.x,b.y);k=new r(p.lastProjectedX,p.lastProjectedY);o.push({label:this,text:this.data.iconText,anchor:k,sourceCrs:e.crs,placement:n.middleCenter})}for(d=this._measureLabel(),h=v.getIconBounds(this.data.iconTemplates,this.data.iconText).getSize(),this.data.offsetX||(this.data.offsetX=h.width/2+y._defaultIconLabelOffset),this.data.offsetY||(this.data.offsetY=h.height/2+y._defaultIconLabelOffset),c=0,g=o.length;c<g;c++)f=o[c],f.text=this.data.iconText,f.type=1,f.size=h,this.regions.push(f),this.data.text&&Array.prototype.push.apply(this.regions,this._getTextRegions(f.anchor,d,f))},i.prototype._setReplicaProximityForLabelHints=function(){this.replicaProximity=200},i._MAX_REPLICAS=10,i._roadShieldPlacements=[n.topCenter],i._roadShieldModifierStyle={styleStatic:{font:"SegoeBing",fontSize:7.5,fontOutlined:!0,fontWeight:3,outlineWidth:1,horizontalAlignment:0},styleDynamic:{fontColor:"#000",outlineColor:"#fff",globalOrder:726,visible:!0,priority:0}},i._aerialShieldModifierStyle={styleStatic:{font:"SegoeBing",fontSize:7.5,fontOutlined:!0,fontWeight:3,outlineWidth:1,horizontalAlignment:0},styleDynamic:{globalOrder:726,visible:!0,fontColor:"#fff",outlineColor:"#555",priority:0}},i}(et),ii=function(){function n(){this._index=new it;this._occludedIndex=new it}return n.prototype.reset=function(n,t){this._index.reset(n,t);this._occludedIndex.reset(n,t)},n.prototype.addLabels=function(t){for(var r,e,f,c,i,o,s,l,u=0,h=t.length;u<h;u++)if(r=t[u],r.shouldBeRendered)for(e=r.getRegions(),f=0,c=e.length;f<c;f++)(i=e[f],i.id=i.id||n._regionId++,!i.isFixed||(o=!0,i.type===1&&(s=r.data.primitives[0].layer,o=s&&wt.getValue(s,"renderTarget")===1),o&&r.placedRegions.push(i),i.occludesOthers))&&(l=i.occludesOthers?this._occludedIndex:this._index,l.add(i,i.bounds.bbox))},n.prototype.addRenderables=function(n){for(var i,t=0,r=n.length;t<r;t++)i=n[t].region,this._index.add(i,i.rect)},n.prototype.getOverlappingRegions=function(n){return this._getOverlappingRegions(n,this._index)},n.prototype.getOverlappingOccludedRegions=function(n){return this._getOverlappingRegions(n,this._occludedIndex)},n.prototype._getOverlappingRegions=function(n,t){for(var i,f,r=n.rect,e=t.getOverlappingRegions(r||n.bounds.bbox),o=[],s={},u=0,h=e.length;u<h;u++)i=e[u],s[i.id]||(f=!1,i.isRejected||i.label.id===n.label.id||(f=r?r.intersects(i.rect):n.bounds.intersects(i.bounds)),f&&o.push(i),s[i.id]=!0);return o},n.prototype.getRegions=function(n,t){return this._index.getRegions(n,t)},n.prototype.getHeight=function(){return this._index.getHeight()},n.prototype.getWidth=function(){return this._index.getWidth()},n._regionId=0,n}(),ri=function(){function n(){this._labelsById={};this._index=new ii;this._landmarksCount=0}return n.prototype.computeRenderables=function(i,r,u,e){var b,y,o,a,v,k,d,g;e&&(this._labelsById={});var s=[],h=0,l=0,nt=c.fromSides(0,u.pixelWidth,0,u.pixelHeight),p=[],w=0;this._addLabelsToCache(i);b=t._getCurrentTimeStamp();for(y in this._labelsById)if(this._labelsById.hasOwnProperty(y)){if(o=this._labelsById[y],o.data.dirty&&o.data.primitives.length===0)delete this._labelsById[o.id],p.push(o.id);else{if(o.reset(),!o.data.style)continue;o.initializePosition(u,r);n._isInDisplay(o,nt)&&(s.push(o),l++)}h++}return w=t._getCurrentTimeStamp()-b,h!==l&&f.log(null,"CollisionManager: received {0} labels out of which {1} in display, {2} outside display",h,l,h-l),a=t._getCurrentTimeStamp(),this._sortByXsrPriority(s),a=t._getCurrentTimeStamp()-a,this._index.reset(u.pixelWidth,u.pixelHeight),this._index.addLabels(s),v=t._getCurrentTimeStamp(),this._doFirstPlacementPass(s),v=t._getCurrentTimeStamp()-v,k={sortTime:a,collisionTime:v,initializePositionTime:w},this._index.reset(0,0),d=this._createRenderables(s),g={newRenderables:d,removedRenderables:p,diagnosticArgs:k,landmarksCount:this._landmarksCount},g},n.prototype._addLabelsToCache=function(n){for(var i,t=0,r=n.length;t<r;t++)i=n[t],this._labelsById[i.id]=i},n.prototype._sortByXsrPriority=function(n){n.sort(function(n,t){var i=n.data,r=t.data,h=i.drawOrder||0,c=r.drawOrder||0,w=i.priorityGroup===o.poiStylePriorityGroup,b=r.priorityGroup===o.poiStylePriorityGroup,l=0,y,p,e,s,u,f;if(w&&b)return i.priority-r.priority||h-c;if(w)return-1;if(b)return 1;var a=i.style.styleStatic.strataStyle,v=r.style.styleStatic.strataStyle,k=a&&a.alpha&&a.alpha<1,d=v&&v.alpha&&v.alpha<1;if(k&&!d)return-1;if(d&&!k)return 1;if(y=parseInt(i.entityId),p=parseInt(r.entityId),i.priorityGroup!==0&&r.priorityGroup!==0&&i.priorityGroup===r.priorityGroup)return h-c||y-p;if(i.priority===r.priority){if(e=i.lowImportanceCollisionPadding,s=r.lowImportanceCollisionPadding,e===0&&s!==0)return-1;if(e!==0&&s===0)return 1;if(u=i.labelImportance,f=r.labelImportance,u!==-1&&f===-1)return-1;if(u===-1&&f!==-1)return 1;if(u!==-1&&f!==-1)if(u===f){if(l=e-s,l!==0)return l}else return u-f;return h-c||y-p}return i.priority-r.priority});for(var t=0;t<n.length;t++)n[t].placementPriority=t},n.prototype._doFirstPlacementPass=function(n){for(var e,a,t,o,p,nt,r,u,c=0,y=n.length;c<y;c++){var s=n[c],f=s.getRegions(),i=null,l=!1;if(h.debugLabels&&f.length){s.placedRegions.push(f[0]);continue}for(e=0,a=f.length;e<a;e++)if((t=f[e],o=t.parentRegion,!t.isRejected&&!t.isFixed&&(!o||!o.isRejected))&&(t.type!==1||s.data.iconTemplates)){if(o?i===o&&(l=!0):(i&&!i.isFixed&&l&&(i.isRejected=!0),i=t,l=!1),p=this._index.getOverlappingOccludedRegions(t),p.length>0){t.isRejected=!0;continue}for(var w=this._index.getOverlappingRegions(t),b=w.length,v=!1;b--;){for(var k=w[b],d=k.label.placedRegions,g=d.length;g--;)if(nt=d[g],nt===k){v=!0;break}if(v)break}if(v){t.isRejected=!0;continue}if(s.placedRegions.push(t),o){for(r=e+1;r<a;r++)u=f[r],u.isFixed||u.parentRegion!==o||(u.isRejected=!0);i=null}else if(s.replicaProximity)this._filterReplicas(t,e,s.replicaProximity,f);else for(r=e+1;r<a;r++)u=f[r],u.isFixed||u.parentRegion===t||(u.isRejected=!0)}i&&!i.isFixed&&l&&(i.isRejected=!0)}},n.prototype._filterReplicas=function(n,t,i,r){var e=n.bounds.bbox.clone(),f,o,u;for(e.buffer(i,i),f=t+1,o=r.length;f<o;f++)u=r[f],u.isFixed||u.isRejected||u.parentRegion||!e.intersects(u.bounds.bbox)||(u.isRejected=!0)},n.prototype._createRenderables=function(n){for(var r,s,t,f,l=[],a=0,c=0,y=n.length;c<y;c++){var i=n[c],u=i.data,o=i.placedRegions,v=[];for(r=0,s=o.length;r<s;r++)t=o[r],t&&!t.isRejected&&(t=i.lastUsedRegion(t),f=u.primitives[0],e.isLandmarkEntity(f.entity)&&t.type&&t.type===1&&a++,l.push({id:t.id.toString(),type:u.type,text:t.text,secondaryText:t.secondaryText,lineWidths:i.lineWidths,labelId:i.id,region:t,geometryType:f.geometryType,iconTemplates:u.iconTemplates,style:u.style,fontSize:u.fontSize,secondaryFontSize:u.secondaryFontSize,layerZIndex:f.layer&&parseInt(f.layer.getZIndex()),labelZIndex:h.useLabelZIndex&&f.zIndex||0}),v.push(t));for(i.lastUsedRegions=v,o=i.regions,r=0,s=o.length;r<s;r++)t=o[r],t.bounds.bounds=[];i.regions=[]}return this._landmarksCount=a,l},n._isInDisplay=function(n,t){for(var r,u=n.getRegions(),f=!1,i=0,e=u.length;i<e;i++)r=u[i],t.intersects(r.bounds.bbox)?f=!0:r.isRejected=!0;return f},n}(),ui=function(){function n(n,t,i){var r=this;this._workDispatcher=i;this._templateName=t;this._collisionManager=new ri;this._messageQueue=[];this.message=new s;this._mainThreadMessageSubscription=n.message.add(function(n){return r._queueMessage(n)})}return n.prototype.dispose=function(){this._mainThreadMessageSubscription&&(this._mainThreadMessageSubscription.dispose(),this._mainThreadMessageSubscription=null)},n.prototype._queueMessage=function(n){var r=this,t=this._getWorkDispatcherKeyForFrame(n.frame),i;n.type===2?this._workDispatcher.cancelDispatchWithKey(t,4):(this._messageQueue.push(n),i=function(){r._processMessage()},this._workDispatcher.dispatch(i,t,4))},n.prototype._getWorkDispatcherKeyForFrame=function(t){return n._dispatchKey+t.frameNumber},n.prototype._processMessage=function(){var r=this,n,t,i;if(this._messageQueue.length!==0){n=this._messageQueue.shift();switch(n.type){case 0:this._processPrimitivesChangedMessage(n);break;default:throw"Unknown MessageType: "+n.type;}this._messageQueue.length>0&&(t=this._getWorkDispatcherKeyForFrame(this._messageQueue[0].frame),i=function(){r._processMessage()},this._workDispatcher.dispatch(i,t,4))}},n.prototype._processPrimitivesChangedMessage=function(n){for(var r,u,s,f,i,e=t._getCurrentTimeStamp(),h=[],o=0,c=n.newLabels.length;o<c;o++){r=n.newLabels[o];s=r.type;switch(s){case 0:u=new y(r);break;case 1:u=new et(r);break;case 2:u=new ot(r);break;case 3:u=new ni(r);break;case 4:u=new ti(r,this._templateName);break;default:throw"Unknown LabelType: "+s;}h.push(u)}f=t._getCurrentTimeStamp();i=this._collisionManager.computeRenderables(h,n.zoom,n.viewport,n.isDiffFrameDisabled);f=t._getCurrentTimeStamp()-f;e=t._getCurrentTimeStamp()-e;i.diagnosticArgs.computeRenderablesTime=f;i.diagnosticArgs.primitiveChangeProcessingTime=e;i.diagnosticArgs.landmarksCount=i.landmarksCount;this._postMessage({type:1,frame:n.frame,region:n.viewport,newRenderables:i.newRenderables,removedRenderables:i.removedRenderables,labelWorkerDiagnosticArgs:i.diagnosticArgs,zoom:n.zoom})},n.prototype._postMessage=function(n){this.message.invoke(n)},n._dispatchKey="LabelerWorker:",n}(),w=function(){function n(n,t){var i=this;this._disposables=[];this.message=new s;this.primitiveProcessingComplete=new s;this._workDispatcher=t;this._controller=n;this._worker=new ui(this,n.getBaseTemplateName(),t);this._labelDataByLabelId={};this._changedHandlersByLabelId={};this._alwaysRaiseEvents=!1;this._disposables.push(this._worker.message.add(function(n){if(i._currentFrame&&n.frame.frameNumber===i._currentFrame.frameNumber){var t=i._getWorkDispatcherKeyForFrame(n.frame),r=function(){i._processWorkerMessage(n)};i._workDispatcher&&i._workDispatcher.dispatch(r,t,4)}}));this.labelsProcessed=new s}return n.prototype.processData=function(n,t,i,r,u,f,e){var l,a,s,c,v,y,p,o,h,w;if(t&&r){for(this._showLabelBackground=e,f&&(this._labelDataByLabelId={}),this._currentFrame=n,l={type:0,frame:this._currentFrame,viewport:r,zoom:u,newLabels:[],newPrimitives:[],removedPrimitives:[],isDiffFrameDisabled:f},a=t.removedPrimitives,o=0,h=a.length;o<h;o++){if(s=a[o],!s.labelIds){if(c=this._createLabelData(s,!1),!c||!c.length)continue;for(s.labelIds=[],v=c.length;v--;)y=this._labelDataByLabelId[c[v].labelId],y&&s.labelIds.push(y.labelId)}this._removePrimitivesFromLabelData(s)}for(this._labelDrawOrder={},p=t.addedPrimitives,o=0,h=p.length;o<h;o++)this._associateLabelsWithPrimitive(p[o],i,l);for(o=0,h=t.changedPrimitives.length;o<h;o++)w=t.changedPrimitives[o],this._removePrimitivesFromLabelData(w),this._associateLabelsWithPrimitive(w,i,l);this._postMessage(l)}},n.prototype.cancelProcessingForFrame=function(n){var t=!!this._currentFrame,i={type:2,frame:n};return this._postMessage(i),this._workDispatcher&&this._workDispatcher.cancelDispatchWithKey(this._getWorkDispatcherKeyForFrame(n),4),this._currentFrame=null,t},n.prototype._getWorkDispatcherKeyForFrame=function(t){return n._dispatchKey+t.frameNumber},n.prototype._associateLabelsWithPrimitive=function(n,i,r){var f=n.layer&&n.layer.getId(),v=f&&i[f],s=this._createLabelData(n,v),e,l,o,h,u,a,c;if(s&&s.length)for(n.labelIds=[],e=0,l=s.length;e<l;e++){for(o=s[e],n.labelIds[e]=o.labelId,h=d.getKey(n,o),u=this._labelDataByLabelId[h],u?u.dirty=!0:(u=o,r.newLabels.push(o),this._labelDataByLabelId[h]=o),f=n.layer&&n.layer.getId(),f&&(u.drawOrder=this._labelDrawOrder[f]||0,this._labelDrawOrder[f]=u.drawOrder+1),n.labelIds[e]=u.labelId,c=u.primitives.length;c--;)if(t._arePrimitivesEqual(u.primitives[c],n)){a=!0;break}a||u.primitives.push(n)}},n.prototype._removePrimitivesFromLabelData=function(n){var f,e,i,r,u;if(n.labelIds&&n.labelIds.length)for(f=n.labelIds.length;f--;)if(e=n.labelIds[f],i=this._labelDataByLabelId[e],i){if(r=i.primitives.indexOf(n),r<0)for(u=i.primitives.length;u--;)if(t._arePrimitivesEqual(i.primitives[u],n)){r=u;break}r>=0&&(i.dirty=!0,i.primitives.splice(r,1))}},n.prototype.dispose=function(){var i=this,n;t._clearDisposables(this._disposables);n=Object.keys(this._changedHandlersByLabelId);n.forEach(function(n){return t._clearDisposables(i._changedHandlersByLabelId[n])});this._changedHandlersByLabelId={};this._labelDataByLabelId={};this._worker=null;this._controller=null},n.prototype._disposeChangedHandlers=function(n){t._clearDisposables(this._changedHandlersByLabelId[n]);delete this._changedHandlersByLabelId[n]},n.prototype._processWorkerMessage=function(n){var e,h,c,l,t,p,u,o;switch(n.type){case 1:var r=n,v=r.removedRenderables,f={};for(t=0,e=v.length;t<e;t++)h=v[t],delete this._labelDataByLabelId[h],this._disposeChangedHandlers(h);for(c=r.newRenderables,t=0,e=c.length;t<e;t++){var y=c[t],i=y.labelId,u=f[i];u||(u=[],f[i]=u);u.push(y)}for(l=Object.keys(f),t=0,p=l.length;t<p;t++)if(i=l[t],u=f[i],o=this._labelDataByLabelId[i],o){var a=o.primitives[0],w=a.entity,b=this._updateExistingLabel.bind(this,u,o),s=[];w.changed&&s.push(w.changed.add(b));a.changing&&s.push(a.changing.add(b));this._disposeChangedHandlers(i);s.length&&(this._changedHandlersByLabelId[i]=s)}this._currentFrame=null;this.primitiveProcessingComplete.invoke(r.labelWorkerDiagnosticArgs);this._raiseLabelsProcessedEvent(r.region,r.newRenderables,r.zoom);break;default:throw"Unknown MessageType: "+n.type;}},n.prototype._updateExistingLabel=function(n,t,i){if(this._controller){var r=t.primitives[0],u=!1;r&&(i&&i.sender===r?i.name==="location"&&(this._updateLocation(n,t,i.newValue),u=!0):(this._updateStyle(n,t,r),h.useLabelZIndex&&this._updateZIndex(n,r),u=!0));u&&this._controller.invalidateLabels()}},n.prototype._updateLocation=function(n,t,i){var s=this._controller.getViewport(),f,h,c,e,a,u,o;if(s)for(f=new l(dt.instance,s),f.project(i.longitude,i.latitude),h=f.lastProjectedX,c=f.lastProjectedY,e=0,a=n.length;e<a;e++)u=n[e].region,u&&(o=new r(h,c),u.anchor=o,u.bounds&&u.bounds.setAnchor(o))},n.prototype._updateStyle=function(n,t,i){var f=i.viewState,r,u;for(this._controller.addStyle(t.primitives,f),t.style=i.style,r=0,u=n.length;r<u;r++)n[r].style=t.style,n[r].iconTemplates=t.iconTemplates=i.iconTemplates&&i.iconTemplates.length?i.iconTemplates:null},n.prototype._updateZIndex=function(n,t){for(var r=t.zIndex||0,i=0,u=n.length;i<u;i++)n[i].labelZIndex=r},n.prototype._createLabelData=function(t,i){var f=t.entity,r,ft,c,l,it,ot;if(!t.entity||(r=t.style,ft=n._isValidStyle(r),!ft))return null;if(!t.entity.labelHint){var et=e.getLabelImportance(f),p=0;if((r.styleDynamic.visible&&r.styleDynamic.densityLodDelta&&r.styleDynamic.densityLodDelta!==ut.markupVisible&&r.styleDynamic.densityLodDelta!==ut.markupInvisible&&(r.styleDynamic.visible=et>=0?et<=255-r.styleDynamic.densityLodDelta*r.styleDynamic.densityImportance:r.styleDynamic.densityLodDelta<=(255-r.styleDynamic.densityImportance)/50+1,r.styleDynamic.visible&&(p=r.styleDynamic.densityLodDelta*r.styleDynamic.densityDistance+.5)),!r.styleDynamic.visible)||t.geometryType===2&&t.geometry.x.length<2)return null}var w=h.roadShieldsEnabled&&e.getShieldIndices(f),b=w&&w.length&&e.getShieldNames(f),s=t.iconTemplates,k=b&&b.length&&s,ht=e.isLandmarkEntity(f),o=!!(k&&k.length),a=s&&!!s[0],u=e.getDisplayName(f),v=u&&e.getSecondaryDisplayName(f),y=e.getIconText(f);if(o){var g=t.entity.labelHint,nt=g&&g.lbl&&g.lbl[0],tt=nt&&nt.tps&&nt.tps[0];tt&&tt.n&&(o=!1,a=!1,u=tt.n)}if((c=a&&!o&&(i||!u||s[0].hasText&&!y||st.isIconStyle(r)),r.styleStatic.showBackground=this._showLabelBackground,!o&&r.styleStatic.shieldLabelVisibility===1)||!u&&!o&&!c)return null;if(o)return n._createShieldLabelData(t,f,r,p,w,b,k);r.styleStatic.wrapDisplayName&&(u=n.wrapText(u));r.styleStatic.fontCaps===2&&(u=u.toUpperCase(),v=v.toUpperCase());l=1;it=0;switch(t.geometryType){case 1:l=c?0:1;it=r.styleDynamic.priority;ot=!c&&n._getPointLabelType(ht,a,t.bucket);break;case 3:l=3;break;case 2:l=o?4:2}c&&(y=y||u,u=null,v=null);var ct=r.styleStatic.fontSize,lt=r.styleStatic.secondaryFontSize,rt=[{labelId:null,entityId:f.id,bucket:t.bucket,primitives:[],crs:t.crs,lowImportanceCollisionPadding:p,labelImportance:e.getLabelImportance(f),fontSize:ct,secondaryFontSize:lt,priority:r.styleDynamic.globalOrder,text:u,secondaryText:v,iconText:y,type:l,pointType:ot,priorityGroup:it,offsetX:r.styleStatic.offsetX,offsetY:r.styleStatic.offsetY,imageWidth:r.styleStatic.imageWidth,imageHeight:r.styleStatic.imageHeight,style:r,iconTemplates:a?s:null}];return rt[0].labelId=d.getKey(t,rt[0]),rt},n._createShieldLabelData=function(n,t,i,r,u,o,s){var v=[],a,h,y,c,p,l;for(f.assert(!!(u&&u.length),"No shield indices"),f.assert(!!(o&&o.length),"No shield names"),f.assert(!!(s&&s.length),"No shield templates"),a=0,h=0;h<s.length;h++)s[h]&&a++;for(f.assert(u.length===o.length&&o.length===a,"Shield indices, names and templates don't match"),h=0,y=o.length;h<y;h++)c=e.getShieldDisplayData(o[h]),p=s[h],c&&c.text&&p&&(l={labelId:null,entityId:t.id,bucket:n.bucket,primitives:[],crs:n.crs,lowImportanceCollisionPadding:r,labelImportance:e.getLabelImportance(t),fontSize:i.styleStatic.fontSize,priority:i.styleDynamic.globalOrder,text:c.modifier,iconText:c.text,type:4,priorityGroup:0,offsetX:i.styleStatic.offsetX,offsetY:i.styleStatic.offsetY,imageWidth:i.styleStatic.imageWidth,imageHeight:i.styleStatic.imageHeight,style:i,iconTemplates:[s[h]],shieldIndex:u[h]},l.labelId=d.getKey(n,l),v.push(l));return v},n._getPointLabelType=function(n,t,i){switch(i){case o.pricePoiBucketId:case o.bucketIdForPoi:case o.bucketIdForDirectionsPins:return 1;case o.bucketIdForSelectedPoi:return 2;case o.bucketIdForTransientLensTop:return 3;case o.bucketIdForTransientLensBottom:return 4;case o.bucketIdForTransientLensLeft:return 5;case o.bucketIdForTransientLensRight:return 6;default:return n?8:t?9:0}},n.wrapText=function(t,i){var r;if(i=i||n._minWrapLength,t&&t.length>=i&&(r=t.split(/\s+/),r.length>1)){for(var e=t.length/2,u="",f="";r.length;){while(r.length&&u.length<=f.length)u=u+" "+r.shift();while(r.length&&f.length<=u.length)f=r.pop()+" "+f}Math.abs(u.length-f.length)<e*2/3&&(t=(u+"\n"+f).trim())}return t},n.wrapTextToFit=function(t,i,r){var s,o,l;if(i.width>r.width)if(s=Math.max(Math.round(i.width/r.width),2),s==2)t=n.wrapText(t,0);else{var y=Math.ceil(t.length/s),c=t.split(/\s+/),e=[],u="",f=!1;for(o=0,l=c.length;o<l;o++){var h=c[o],a=h.length,p=u.length+a+(f?1:0),v=p-y;v<=a/2?(u=u+(f?" ":"")+h,f=!0,v>=0&&(e.push(u),u="",f=!1)):(e.push(u),u=h,f=!0)}u&&e.push(u);t=e.join("\n").trim()}return t},n.prototype._raiseLabelsProcessedEvent=function(n,t,i){var r={region:n,labels:t,zoom:i};this.labelsProcessed.invoke(r)},n.prototype._postMessage=function(n){this.message.invoke(n)},n._isValidStyle=function(n){return!!(n&&n.styleStatic&&n.styleDynamic.fontColor&&n.styleStatic.fontSize&&n.styleStatic.font)},n.collisionAlphaThreshold=.58,n._minWrapLength=20,n._dispatchKey="Labeler:",n}(),a=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),st=function(n){function i(t,i,r){var u=this,f={};return u=n.call(this,f)||this,u._isShutDown=!0,f.defineProperty("isLabelsEnabled",function(n,t){u._onIsLabelsEnabledChanged(n,t);u.labelsEnabledChanged.invoke(t)}),f.defineProperty("isUserLabelsEnabled",function(n,t){u._onIsUserLabelsEnabledChanged(n,t)}),u.instrumentLabelingPass=new s,u.labelsEnabledChanged=new s,u._labelingDiagnostics={},u._disposables=[],u._mapEvents=[],u._coreConfig=t,u._hitTestController=i,u._workDispatcher=r,u.hitTestPriority=1,u}return a(i,n),i.prototype.attach=function(n){var t=this;this._map=n;this._labelUserMapLayers=this.getIsLabelsSupported();this._mapEvents.push(this._map.changed.add(function(n){n.name==="mode"&&t._onMapModeChanged(n.newValue)}));this._mapEvents.push(this._map.mapTypeChanged.add(function(n){t._onMapTypeChanged(n)}))},i.prototype.getIsLabelsSupported=function(){return this._map.getMode()?this._isSupportedMapTypeForLabels(this._map.getMapType().id)&&this._isSupportedMapModeForLabels(this._map.getMode().mapModeType):!0},i.prototype.getBaseTemplateName=function(){return this._templateName},i.prototype.dispose=function(){this._shutDown();n.prototype.dispose.call(this);this._hitTestController=null;t._clearDisposables(this._mapEvents)},i.prototype._onFrameSet=function(n){var i=n.frame,t;this._currentLabelRenderingContext&&this._currentLabelRenderingContext.frame&&(t=this._labeler&&this._labeler.cancelProcessingForFrame(this._currentLabelRenderingContext.frame),this._vectorLabels&&this._vectorLabels.cancelRender(this._currentLabelRenderingContext),t&&(this._previousFrameData=null));this._finalVectorLabelRenderCompleteHandler&&this._finalVectorLabelRenderCompleteHandler.dispose();this._finalVectorLabelRenderCompleteHandler=null;this._currentLabelRenderingContext={frame:i,paintId:0};this._isFinalPaintInitiated=!1},i.prototype.performHitTesting=function(n,t){this._vectorLabels&&!this._isShutDown&&this._vectorLabels.performHitTesting(n,t)},i.prototype._initLabelRenderer=function(){this._vectorLabels&&this._vectorLabels.dispose();this._vectorLabels=new lt(this._map)},i.prototype._bootStrap=function(){var n=this;this._haveLabeledFirstFrame=!1;this._shutDown();this._isShutDown=!1;this._hitTestController&&this._hitTestController.addComponent(this);this._map.getTemplateSelector().then(function(t){return n._templateSelector=t,n._templateName=(t.getName()||"").toUpperCase(),t.selectorReady()}).then(function(){return n._onTemplateSelectorReady()})},i.prototype._onTemplateSelectorReady=function(){if(!this._isShutDown){f.log(null,"Hooking up LabelController to FrameManager and CompositeMode events");this._createLabeler();this._initLabelRenderer();var n=this._map.getMode();n.mapModeType===0&&this._subscribeToMapEvents()}},i.prototype._shutDown=function(){this._isShutDown||(this._disposables.forEach(function(n){n.dispose()}),this._disposables=[],this._labeler=null,this._vectorLabels&&(this._vectorLabels.dispose(),this._vectorLabels=null),this._hitTestController&&this._hitTestController.removeComponent(this),this._isShutDown=!0)},i.prototype._subscribeToMapEvents=function(){var n=this;f.assert(this._map.getMode().mapModeType===0,"Labeling only works in composite map mode");this._map.getMode().mapModeType===0&&(this._map.getFrameManager()!=null?this._subscribeToFrameManagerEvents():this._map.frameManagerLoaded.addOne(function(){n._subscribeToFrameManagerEvents()}))},i.prototype.getViewport=function(){return this._viewport},i.prototype.setViewport=function(n){this._viewport=n},i.prototype.renderLabels=function(n,i){var r=this;this._currentLabelRenderingContext&&this._currentLabelRenderingContext.frame&&((this._isFinalPaintInitiated||this._labelInvalidated)&&f.clearTestHooksLog(f.UserLogTag),this._currentLabelRenderingContext={frame:this._currentLabelRenderingContext.frame,paintId:this._currentLabelRenderingContext.paintId++},this._vectorLabels||this._initLabelRenderer(),this._isFinalPaintInitiated&&(this._labelingDiagnostics.renderingTime=t._getCurrentTimeStamp(),this._finalVectorLabelRenderCompleteHandler=this._vectorLabels.renderingComplete.add(function(n){n.labelRenderingContext&&n.labelRenderingContext.frame&&r._currentLabelRenderingContext&&r._currentLabelRenderingContext.frame&&n.labelRenderingContext.frame.frameNumber===r._currentLabelRenderingContext.frame.frameNumber&&n.labelRenderingContext.paintId===r._currentLabelRenderingContext.paintId&&(r._labelingDiagnostics.totalLabelingTime+=n.delayedRenderingTime,r._labelingDiagnostics.delayedRenderingTime=n.delayedRenderingTime,r._finalVectorLabelRenderCompleteHandler&&r._finalVectorLabelRenderCompleteHandler.dispose(),r._finalVectorLabelRenderCompleteHandler=null,r._completeLabelRenderingPhase())})),this._vectorLabels.render(n,this._currentLabelRenderingContext,this._labelingDiagnostics,i,this._labelInvalidated),this._labelInvalidated=!1,this._isFinalPaintInitiated&&(this._labelingDiagnostics.renderingTime=t._getCurrentTimeStamp()-this._labelingDiagnostics.renderingTime,this._labelingDiagnostics.totalLabelingTime=t._getCurrentTimeStamp()-this._labelingDiagnostics.totalLabelingTime,this._isFinalPaintInitiated=!1))},i.prototype._subscribeToFrameManagerEvents=function(){var i=this,n=this._map.getFrameManager(),t;this._disposables.push(n.frameSet.add(function(n){i._onFrameSet(n)}));this._disposables.push(n.primitivesRendered.add(function(n){i._showLabelsForFrame(n.frame)}));t=n.getFrame();t&&(this._onFrameSet({frame:t}),n.hasCurrentFrameCompletedPrimitiveRenderingPhase()&&this._showLabelsForFrame(t))},i.prototype._createLabeler=function(){var n=this;this._labeler||(this._disposables.push(this._labeler=new w(this,this._workDispatcher)),this._disposables.push(this._labeler.primitiveProcessingComplete.add(function(t){return n._primitiveProcessingComplete(t)})),this._disposables.push(this._labeler.labelsProcessed.add(function(t){return n._showLabels(t)})))},i.prototype._isSupportedMapTypeForLabels=function(){return!0},i.prototype._isSupportedMapModeForLabels=function(n){return n===0},i.prototype._isDiffingDisabled=function(){return!0},i.prototype._showLabelsForFrame=function(n){var r=this,u,v=this._map.getFrameManager(),f=this._getMapFrameData(),e=this._isDiffingDisabled(),o,s,a;if(this._haveLabeledFirstFrame=!0,o=!e&&f&&this._previousFrameData,this._labelingDiagnostics={frameNumber:n.frameNumber},s=t._getCurrentTimeStamp(),this._labelingDiagnostics.totalLabelingTime=s,this._labelingDiagnostics.diffingTime=s,f&&(o?u=v.diffFrames(o,f,1):(u={addedPrimitives:f.getPrimitives(1),removedPrimitives:[],changedPrimitives:[]},e=!0)),this._labelingDiagnostics.diffingTime=t._getCurrentTimeStamp()-this._labelingDiagnostics.diffingTime,u){var l=this._map.getMapOptions().liteMode||i._isNullDataRegionFrame(f),c={},y=f.getLayerFrameData();y.forEach(function(n){var t=n.layer,r=t&&t.getIconOnlyLimit(),i;r>0&&(i=n.getPrimitives(1),i&&i.length>=r&&(c[t.getId()]=!0))});this._labelingDiagnostics.primitiveCount=u.addedPrimitives.length;this._labelingDiagnostics.timeToAddStyles=t._getCurrentTimeStamp();h.awaitIconSelectors?(a=this._getIconTemplateSelectorsAndFetchIconImages(u.addedPrimitives),this._previousFrameData=f,Promise.all(a).then(function(){r._previousFrameData===f&&r._labeler&&(r.addStyle(u.addedPrimitives),r.addStyle(u.removedPrimitives),r.addStyle(u.changedPrimitives),r._labelingDiagnostics.timeToAddStyles=t._getCurrentTimeStamp()-r._labelingDiagnostics.timeToAddStyles,r._labelingDiagnostics.labelDataProcessingTime=t._getCurrentTimeStamp(),r._labeler.processData(n,u,c,r._viewport,r._map.getMercatorZoomLevel(),e,l),r._labelingDiagnostics.labelDataProcessingTime=t._getCurrentTimeStamp()-r._labelingDiagnostics.labelDataProcessingTime)})):(this.addStyle(u.addedPrimitives),this.addStyle(u.removedPrimitives),this.addStyle(u.changedPrimitives),this._labelingDiagnostics.timeToAddStyles=t._getCurrentTimeStamp()-this._labelingDiagnostics.timeToAddStyles,this._labelingDiagnostics.labelDataProcessingTime=t._getCurrentTimeStamp(),this._labeler.processData(n,u,c,this._viewport,this._map.getMercatorZoomLevel(),e,l),this._labelingDiagnostics.labelDataProcessingTime=t._getCurrentTimeStamp()-this._labelingDiagnostics.labelDataProcessingTime,this._previousFrameData=f)}},i.isIconStyle=function(n){return n===i._iconStyle},i.prototype.addStyle=function(n,t){var u,o,f,i,s,r,c;if(n)for(u=this._map.getMercatorZoomLevel(),o=k.toScale(null,u,!0),f=n.length-1;f>=0;f--)i=n[f],i.style=this._templateSelector.getMarkupRecord(u,i.bucket,i.geometryType,t),e.isLandmarkEntity(i.entity)&&i.style&&(s=i.style.styleStatic,s.wrapDisplayName=!0),i.geometryType===1&&h.renderIconLabels?(r=i.layer,(!r||r.getRenderTarget()===1||i.entity&&i.entity.collisionBehavior===2)&&(c=r&&r.getTemplateSelector()||this._templateSelector,this._setMarkupStyle(i,c,o))):h.roadShieldsEnabled&&(i.iconTemplates=this._templateSelector.getFetchedShields(u,i.bucket,e.getShieldIndices(i.entity)))},i.prototype._getIconTemplateSelectorsAndFetchIconImages=function(n){var p={},u,w,s,a,i,v,y;if(!h.renderIconLabels)return null;var c={},l=[],r=Array();for(u=0,w=n.length;u<w;u++){var t=n[u],f=t.geometryType===1&&t.layer,b=f&&f.getTemplateSelector();t.geometryType!==1&&(s=e.getShieldIndices(t.entity),s&&s.length>0&&l.push({bucketId:t.bucket,indexes:s}));b&&(f.getRenderTarget()===1||t.entity&&t.entity.collisionBehavior===2)&&(a=f.getId(),p[a]||(p[a]=!0,r.push(b.selectorReady())),i=t.bucket,i&&(c[i]=!0),(t.catId||t.entity&&t.entity.getSelectedCategoryForIcon)&&(v=t.catId||t.entity.getSelectedCategoryForIcon(),v&&(i=o.localCatIdBucketMapping[v])),i&&(c[i]=!0))}return y=Object.keys(c),y.length>0&&r.push(this._templateSelector.prefetchImagesByBucketIds(y)),l.length>0&&r.push(this._templateSelector.prefetchShields(l)),r},i.prototype.invalidateLabels=function(){var n=this._map.getMode();n&&n.invalidateLabels&&(this._labelInvalidated=!0,n.invalidateLabels())},i.prototype._setMarkupStyle=function(n,t,r){var u=n.iconTemplates=t.getTemplates(n,r);u&&u.length&&!n.style&&(n.style=i._iconStyle)},i.prototype._showLabels=function(n){var t=k.toScale(null,this._map.getMercatorZoomLevel(),!0),i=k.toScale(null,n.zoom,!0);i===t&&(this._vectorLabels||this._initLabelRenderer(),this._vectorLabels.showLabels(n.labels,n.region),this._isFinalPaintInitiated=!0,this.invalidateLabels(),this._zoomLevelForLabelingPhase=this._map.getMercatorZoomLevel())},i.prototype._getMapFrameData=function(){var u=this._map.getFrameManager(),n=u.getFrameData(),t,r,s,h;if(this._labelBaseMapLayers||this._labelUserMapLayers){if(!this._labelBaseMapLayers||!this._labelUserMapLayers){var f=[],e=[],o=n.getLayerFrameData();for(t=0;t<o.length;++t)r=o[t],s=r.layer,i._isBaseMapLayer(s)?e.push(r):f.push(r);h=this._labelBaseMapLayers?e:f;n=new tt(u.getFrame(),h)}}else n=new tt(u.getFrame(),[]);return n},i._isBaseMapLayer=function(n){var i=!1,t=n.getDataSource&&n.getDataSource();return t&&t instanceof yt&&(t=t.getParentDataSource()),t&&t instanceof g&&(i=!0),i},i.prototype._primitiveProcessingComplete=function(n){this._labelingDiagnostics.collisionSortTime=n.sortTime;this._labelingDiagnostics.collisionTime=n.collisionTime;this._labelingDiagnostics.primitiveChangeProcessingTime=n.primitiveChangeProcessingTime;this._labelingDiagnostics.computeRenderablesTime=n.computeRenderablesTime;this._labelingDiagnostics.initializePositionTime=n.initializePositionTime;this._labelingDiagnostics.landmarksCount=n.landmarksCount},i.prototype._completeLabelRenderingPhase=function(){this.instrumentLabelingPass.invoke(this._labelingDiagnostics);this._labelingDiagnostics={};var n=this._map.getFrameManager();n.completeLabelRenderingPhase(this._currentLabelRenderingContext.frame)},i.prototype._onMapTypeChanged=function(n){this.getIsLabelsEnabled()&&n.newMapTypeId!==n.oldMapTypeId&&(this._isSupportedMapTypeForLabels(n.newMapTypeId)?this._bootStrap():this._shutDown())},i.prototype._onMapModeChanged=function(n){this.getIsLabelsEnabled()&&(this._isSupportedMapTypeForLabels(this._map.getMapType().id)&&this._isSupportedMapModeForLabels(n.mapModeType)?this._bootStrap():this._shutDown())},i.prototype._onIsLabelsEnabledChanged=function(n,t){this.getIsLabelsSupported()&&(this._labelBaseMapLayers=t,this._bootStrap())},i.prototype._onIsUserLabelsEnabledChanged=function(n,t){n!==t&&this.getIsLabelsSupported()&&(this._labelUserMapLayers=t,this._bootStrap())},i._isNullDataRegionFrame=function(n){for(var e,s,t,r=!1,u=0,o=n.getLayerFrameData(),f=0;f<o.length;++f)if(e=o[f],s=e.layer,i._isBaseMapLayer(s)&&(t=e.getPrimitives(2),t.length>0))if(t[0].isNullDataRegionMarker){if(r=!0,u>0&&t.length!==u){r=!1;break}u=t.length}else r=!1;return r},i._iconStyle={styleDynamic:{densityDistance:0,densityImportance:0,densityLodDelta:0,globalOrder:20,priority:0,fontColor:"x",visible:!0},styleStatic:{font:"x",fontSize:1}},i}(bt),fi=function(){function n(){this._collisionMap=[]}return n.prototype.collide=function(t,i){for(var r,o,f=[],e=Object.keys(t),u=0,s=e.length;u<s;u++)r=t[e[u]].region,r.rect=r.bounds.getBoundingBoxRelativeTo(r.anchor),r.isRejected=!1,f.push(t[e[u]]);this._scaledViewportWidth=i*n._collisionMapScale;o=Math.ceil(i/32*n._collisionMapScale);this._sort(f);this._collide(f,o)},n.prototype._collide=function(n,t){this._collideGroup(n,t,!0);this._collideGroup(n,t,!1);this._collisionMap=[]},n.prototype._collideGroup=function(t,i,r){for(var h=n._collisionMapScale,f,e,o,l,s,u,c=0,a=t.length;c<a;c++){if(u=t[c].region,s=u.rect,f=Math.ceil(s.minPoint.x*h),e=Math.floor(s.maxPoint.x*h),o=Math.ceil(s.minPoint.y*h),l=Math.floor(s.maxPoint.y*h),f=Math.min(f,e),o=Math.min(o,l),f<0||e>this._scaledViewportWidth){u.isRejected=!0;continue}!!u.occludesOthers!==r||u.isRejected||(u.occludesOthers||!this._isOverlappingRegion(f,e,o,l,i)?this._updateCollisionMap(f,e,o,l,i):u.isRejected=!0)}},n.prototype._updateCollisionMap=function(n,t,i,r,u){this._isOverlappingRegionOrUpdateCollisionMap(n,t,i,r,u,!0)},n.prototype._isOverlappingRegion=function(n,t,i,r,u){return this._isOverlappingRegionOrUpdateCollisionMap(n,t,i,r,u,!1)},n.prototype._isOverlappingRegionOrUpdateCollisionMap=function(n,t,i,r,u,f){for(var h,c=n/32>>0,l=t/32>>0,p=n%32,k=t%32,a,v=-1<<p>>>p,y=-2147483648>>k,w=v&y,o=!1,e,b=this._collisionMap,s=c;s<=l;s++)for(h=i;h<=r;h++)if(a=u*h+s,e=b[a]||0,c===l?f?e|=w:o=(e&w)!=0:s===c?f?e|=v:o=(e&v)!=0:s===l?f?e|=y:o=(e&y)!=0:f?e=-1:o=!!e,f)b[a]=e;else if(o)return!0;return o},n.prototype._sort=function(n){n.sort(function(n,t){return t.drawPriority-n.drawPriority})},n._collisionMapScale=.5,n}(),ht=function(){function t(){this.labelRenderingComplete=new s}return t.prototype.beginDraw=function(){},t.prototype.endDraw=function(){},t.prototype.clear=function(){},t.prototype.cancelRender=function(){},t.prototype.draw=function(){},t.prototype.remove=function(){},t.prototype.update=function(){},t.prototype.size=function(){throw"Not Implemented";},t.prototype.transformContainer=function(){return!1},t.prototype.invalidateHitTestingData=function(){},t.prototype.performHitTesting=function(){},t.prototype.dispose=function(){},t._getTextAnchorOffset=function(i,u){var c=u.width,s=u.height,f=i.region,h=f.placement,l=h&n.horizontalMask||n.right,a=t._horizontalTextAnchorFactor[n[l]],v=c*(a[f.horizontalAlignment]||0),o=0,e;switch(h&n.verticalMask){default:case n.top:o=-s;break;case n.middle:o=-s/2;break;case n.bottom:}return e=new r(v,o),f.anchorOffset&&(e=e.add(f.anchorOffset)),e},t._horizontalTextAnchorFactor={left:[-.5,-1,0],center:[0,-.5,.5],right:[.5,0,1]},t}(),a=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),ct=function(i){function u(n,t){var r=i.call(this)||this;return r._mapEvents=[],r._map=n,r._dpiScale=t,r._addCanvas(),r._positionCanvas(),r._hitTestIndex=new vt,r._labelOptions=n.getMapOptions().labelOptions,r._orderedLabels={},r}return a(u,i),u.prototype.transformContainer=function(n){var t=n.transform(new r(0,0));return this._canvas.set_style({top:t.y-this._heightPadding+"px",left:t.x-this._widthPadding+"px"}),!0},u.prototype.dispose=function(){this._map=null;this._canvas&&this._canvas.clear();this._canvas=null;this._drawingContext&&(this._drawingContext.dispose(),this._drawingContext=null);this._hitTestIndex=null;this._context=null;this._orderedLabels=null;this._mapEvents.forEach(function(n){n.dispose()})},u.prototype.beginDraw=function(n){var t=this._drawingContext;this._currentLabelRenderingContext=n;t?(this._positionCanvas(),t.save()):f.log(null,"Canvas context hasn't been created")},u.prototype.endDraw=function(n,t){var r=this,i=this._drawingContext;i&&(this._drawLabels(!1,t),setTimeout(function(){r.labelRenderingComplete.invoke({labelRenderingContext:n,delayedRenderingTime:0})},0),this._currentLabelRenderingContext=null,this._renderHitTestingContents(i),i.restore())},u.prototype._drawLabels=function(n,t){var s=this._orderedLabels,h=u._getSortedPriorityKeys(Object.keys(s)),p=this._drawingContext,w=this._dpiScale,i,c,r,e,o,l;for(f.clearTestHooksLog(f.LabelDrawOrderTag),i=0,c=h.length;i<c;i++){if(r=s[h[i]],e=Object.keys(r),!e.length){delete s[h[i]];continue}for(o=0,l=e.length;o<l;o++){var a=e[o],v=r[a],y=Object.keys(v);y.length?this._drawLabelsInLayer(v,y,n,t,p,w):delete r[a]}}},u.prototype._drawLabelsInLayer=function(n,t,i,r,u,e){for(var o,a,s,b,w,d,v,nt,k,y=t.length-1;y>=0;y--){o=n[t[y]];f.logLabelDrawOrder(o.text);var p=o.region,h=p.label.data.primitives[0],l=o.iconTemplates;if(!i||(a=l&&l[0],a&&a.getIsHitTestable()&&h&&h.layer)){if(p.type===1){if(s=p.anchor,b=p.anchorOffset,!l)continue;for(w=0,d=l.length;w<d;w++){var a=l[w],c=h,g=c.stretchText!==!1;i?(v=a.getBounds(o.text,g).getSize(),nt=c&&c.getIcon&&c.getIcon()&&!c.getRoundClickableArea(),nt?(k=c.getAnchor(),this._hitTestIndex.addRectangle(h,s.x-k.x,s.y-k.y,v.width,v.height)):this._hitTestIndex.addEllipse(h,s.x+b.x,s.y+b.y,v.width,v.height)):a.renderCanvas(u,{id:null,name:o.text},s.x*e,s.y*e,e,g,f.UserLogTag,h)}}else o.style&&this._drawTextLabel(o,i,r);0}}},u.prototype.cancelRender=function(){this._currentLabelRenderingContext=null},u.prototype.draw=function(n){var r,t,i;n.drawPriority=Math.round((n.fontSize||0)*1e3);r=u._labelKey(n);t=this._orderedLabels[r];t||(t={},this._orderedLabels[r]=t);i=t[n.labelZIndex];i||(i={},t[n.labelZIndex]=i);i[n.id]=n;n.oldLabelZIndex=n.labelZIndex},u.prototype.remove=function(n){var t=this._orderedLabels[u._labelKey(n)],i=t&&t[n.oldLabelZIndex];i&&delete i[n.id]},u.prototype.update=function(n){var t,i=this._orderedLabels[u._labelKey(n)],r=i&&i[n.oldLabelZIndex];r&&(t=r[n.id]);t&&(this.remove(t),this.draw(n))},u.prototype.size=function(n){var t=n.size,i;if(!t){i=n.region&&n.region.type||0;switch(i){case 1:t=v.getIconBounds(n.iconTemplates,n.text).getSize();break;default:t=u.getTextSize(n.text,n.secondaryText,n.style,n.fontSize,n.secondaryFontSize)}t&&t.width&&t.height&&(n.size=t)}return t},u._labelKey=function(n){return(n.layerZIndex||0)*1e6+n.drawPriority},u._getSortedPriorityKeys=function(n){for(var f,e=0,o=!0,r,i=0,u=n.length;i<u;i++){if(r=parseInt(n[i]),r<e){o=!1;break}e=r}if(o)return n;for(f=[],i=0,u=n.length;i<u;i++)t._orderedInsert(f,n[i],null,function(n){return parseInt(n)});return f},u._getLineHeight=function(n){var r=u._lineHeights[n],i;return r||(i=u._scratchElement,i||(i=u._scratchElement=t._createElement("div").appendTo(document.body).appendText("X").set_style({visibility:"hidden",position:"fixed",left:"100%",top:"100%","line-height":"100%"})),i.set_style({font:n}),r=u._lineHeights[n]=i.get_native_prop("offsetHeight")),r},u.getTextSize=function(n,t,i,r,f,e){function l(n,t){var f,l,r,y,v;if(n)for(f=u.createFont(t,i),s=s||u._getLineHeight(f),l=n.split("\n"),h.setFont(f),r=0,y=l.length;r<y;r++)v=a.measureText(l[r]).width,e&&e.push(v),o=Math.max(o,v),c+=s}var h=u._scratchContext,a=h.getRawContext(),o=0,c=0,s=0;return e&&(e.length=0),l(n,r),l(t,f),new b(o,c)},u.prototype.invalidateHitTestingData=function(){this._hitTestIndexValid=!1},u.prototype.performHitTesting=function(n,t){this._hitTestIndexValid||this._renderHitTestData();var i=this._hitTestIndex.hitTest(t);i&&(n.primitive=i,n.layer=i.layer)},u.prototype._addCanvas=function(){this._drawingContext=new nt;this._canvas=this._drawingContext.getRootElement();this._canvas.set_attr("id","labelCanvasId");this._canvas.set_attr("class","labelCanvas");this._canvas.set_style({outline:"none",position:"absolute"});this._context=this._drawingContext.getRawContext();this._map.getMode().getRootElement().append(this._canvas)},u.prototype._positionCanvas=function(){var n=this._map.getActualSize(),e=this._map.getMapOptions(),t=u._maxPadding;e.isPrintMode?t=0:e.liteMode&&(t=u._maxPaddingLiteMode);var r=this._widthPadding=Math.min(t,Math.ceil(.75*n.width)),f=this._heightPadding=Math.min(t,Math.ceil(.75*n.height)),i=this._dpiScale,o=n.width+2*r,s=n.height+2*f;this._drawingContext.setSize(i*o,i*s);this._canvas.set_style({width:o+"px",height:s+"px",top:-f+"px",left:-r+"px"});this._context.translate(i*r,i*f)},u.prototype._renderHitTestData=function(){var n=this._drawingContext,t=n.getSize(),i=this._dpiScale;this._hitTestIndex.reset(t.width/i,t.height/i);n.save();this._drawLabels(!0);n.restore();this._hitTestIndexValid=!0},u.prototype._drawTextLabel=function(n,t,i){var r=n.region,f=this._drawingContext,c=f.getRawContext(),e=n.style,l=this._dpiScale,o,s,h=!1,a;s=r.textSpans&&r.textSpans.length>0?u.createFont(r.textSpans[0].f*l,e):u.createFont(n.fontSize*l,e);f.setFont(s);switch(r.horizontalAlignment){default:case 1:o="left";break;case 0:o="center";break;case 2:o="right"}c.textAlign=o;r.textSpans?this._drawTextWithHints(c,r,e,t,i):(f.save(),a=this._drawTextWithoutHints(f,n,r,s,e,t,i),h=h||a,f.restore(h))},u.prototype._drawTextWithHints=function(n,t,i,r,f){var a=t.textSpans[0].x,v=t.textSpans[0].y,y=this._dpiScale,p=i.styleStatic,b=i.styleDynamic,s,h,o,w,e,c,l;for(p.fontOutlined&&(s=b.outlineColor,h=p.outlineWidth),o=0,w=t.textSpans.length;o<w;o++)e=t.textSpans[o],e.n&&(r?this._hitTestIndex.addRectangle(t.label.data.primitives[0],t.anchor.x+t.anchorOffset.x+(e.x-a),t.anchor.y+t.anchorOffset.y+(e.y-v),parseFloat(e.w),parseFloat(e.h)):(c=y*(t.anchor.x+t.anchorOffset.x+(e.x-a)),l=y*(t.anchor.y+t.anchorOffset.y+(e.y-v)),n.textBaseline="top",e.a!==0&&e.a!=="0"?(n.save(),n.translate(c,l),n.rotate(e.a),u._strokeAndFillText(n,i,e.n,0,0,f,null,null,s,h),n.restore()):u._strokeAndFillText(n,i,e.n,c,l,f,null,null,s,h)))},u.prototype._drawTextWithoutHints=function(t,i,r,f,e,o,s){function st(t){for(var w,i,f,v,b=t?t.split("\n"):[],p=0,k=b.length;p<k;p++,ut++){if(w=b[p],o){i=ot[ut]||h.measureText(w).width;ot[ut]=i;f=0;v=-2;switch(r.horizontalAlignment){case 0:f=-i/2;break;case 2:f=-i}switch(r.placement&n.verticalMask){case n.middle:v=-l/2;break;case n.top:v=-l+2}at.addRectangle(r.label.data.primitives[0],f+r.anchor.x+a.x,v+r.anchor.y+a.y+rt,i,l)}else u._strokeAndFillText(h,e,w,0,c*rt,s,g,et,y,nt);rt+=l}}var h=t.getRawContext(),ct=this.size(i),c=this._dpiScale,l=u._getLineHeight(f)/c,a=ht._getTextAnchorOffset(i,ct),ft=!1;switch(r.placement&n.verticalMask){case n.bottom:h.textBaseline="top";break;case n.middle:h.textBaseline="middle";a.y+=l/2;break;case n.top:h.textBaseline="bottom";a.y+=l}var k=e.styleStatic,lt=e.styleDynamic,d=k.showBackground,v=this._labelOptions,g,et,y,nt;if(this._labelOptions.testRenderStyles&&d?(g=v.glowColor,et=g&&v.glowSize,y=v.outlineColor,nt=y&&v.outlineSize,d=!1):k.fontOutlined&&(y=lt.outlineColor,nt=k.outlineWidth||1),!o&&d){var p=r.bounds.getBoundingBoxRelativeTo(r.anchor),w=Math.floor(p.minPoint.x),b=Math.floor(p.minPoint.y)+2,tt=Math.ceil(p.maxPoint.x-w),it=Math.ceil(p.maxPoint.y-b);w*=c;b*=c;tt*=c;it*=c;e.styleStatic.backgroundColor&&(h.fillStyle=e.styleStatic.backgroundColor,h.fillRect(w,b,tt,it));e.styleStatic.backgroundOutlineColor&&e.styleStatic.backgroundOutlineWidth&&(h.strokeStyle=e.styleStatic.backgroundOutlineColor,h.lineWidth=e.styleStatic.backgroundOutlineWidth*c,h.strokeRect(w,b,tt,it))}h.translate(c*r.anchor.x,c*r.anchor.y);r.orientation&&h.rotate(r.orientation);h.translate(c*a.x,c*a.y);var rt=0,ot=i.lineWidths=i.lineWidths||[],ut=0,at=this._hitTestIndex;return st(i.text),i.secondaryText&&(f=u.createFont(i.secondaryFontSize*c,e),t.setFont(f),st(i.secondaryText),ft=!0),ft},u._strokeAndFillText=function(n,t,i,r,u,f,e,o,s,h){i=t.styleStatic.fontCaps===2&&i.toLocaleUpperCase?i.toLocaleUpperCase():i;var c=n.lineWidth,l=n.strokeStyle;f||(e&&o&&(n.shadowColor=e,n.shadowBlur=o),s&&h&&(n.strokeStyle=s,n.lineWidth=h,n.strokeText(i,r,u)));n.fillStyle=t.styleDynamic.fontColor;t.styleStatic.strataStyle&&t.styleStatic.strataStyle.alpha&&t.styleStatic.strataStyle.alpha<1&&(n.globalAlpha=t.styleStatic.strataStyle.alpha);n.fillText(i,r,u);n.globalAlpha=1;n.lineWidth=c;n.strokeStyle=l;n.shadowBlur=0},u.prototype._renderHitTestingContents=function(){this._map.getIsMapHitTestable()},u.createFont=function(n,t){var f=t.styleStatic.fontItalics?"italic":"",e=t.styleStatic.fontCaps===1?"small-caps":"",i="",r,u;if(t.styleStatic.fontWeight)switch(t.styleStatic.fontWeight){case 3:i="bold";break;case 1:i="lighter"}return r=n+"pt",u=gt.getDefaultFontFamily(t.styleStatic.font),[f,e,i,r,u].join(" ")},u._maxPadding=500,u._maxPaddingLiteMode=100,u._scratchContext=new nt,u._lineHeights={},u}(ht),lt=function(){function n(n){this._disposables=[];this._renderers=[];this._labels={};this._labelCollider=new fi;this.renderingComplete=new s;var i=n.getLabelDpiScale();this._createRenderer(n,i);i!==1&&t._getUrlParam(window.location,"TestLabelDpi")==="1"&&this._createRenderer(n,1,!0)}return n.prototype._createRenderer=function(n,t,i){var u=this,r=new ct(n,t);i||this._disposables.push(r.labelRenderingComplete.add(function(n){window.setTimeout(function(){u.renderingComplete.invoke(n)},0)}));this._disposables.push(r);this._renderers.push(r)},n.prototype.performHitTesting=function(n,t){this._renderers[0]&&this._renderers[0].performHitTesting(n,t)},n.prototype.showLabels=function(n,t){f.log(null,"renderLabels called with {0} labels",n.length);this._renderArgs={labels:n,viewport:t}},n.prototype._showLabels=function(n,t,i){for(var e,v,c=t.transform(i),o=this._labels,l=Object.keys(o),s={},r,h=n.length-1;h>=0;h--){var u=n[h],f=u.region,a=c.transform(f.anchor);f.anchor.x=a.x;f.anchor.y=a.y;f.anchorTransform=c.multiply(f.anchorTransform);r=u.id;s[r]=u;this._renderers.forEach(function(n){o[r]?n.update(u):n.draw(u)})}for(e=0,v=l.length;e<v;e++)r=l[e],s[r]||this._renderers.forEach(function(n){n.remove(o[r])});this._labels=s},n.prototype.dispose=function(){for(var t=this._disposables.length,n=0;n<t;n++)this._disposables[n]&&this._disposables[n].dispose();this._disposables=[];this._renderers=[]},n.prototype.render=function(n,i,r,u,e){var o=null,s,h,c,l;o=this._viewport?this._viewport.transform(n):p.identity;s=o.getZoomDirection();h=!o.nearlyEquals(p.identity,1e-6);(h||this._renderArgs)&&this._renderers[0].invalidateHitTestingData();s||this._renderArgs||e?(this._renderers.forEach(function(n){n.beginDraw(i)}),c=t._getCurrentTimeStamp(),this._fullRender(n,o,s),l=t._getCurrentTimeStamp(),r.fullRenderTime=l-c,r.labelCount=Object.keys(this._labels).length,this._renderers.forEach(function(n){n.endDraw(i,u)})):this._renderers.forEach(function(n){n.transformContainer(o)});f.logLabelData(this._labels)},n.prototype.cancelRender=function(n){this._renderers.forEach(function(t){t.cancelRender(n)})},n.prototype._fullRender=function(n,t,i){var e=this._labels,f,r,h=this._renderArgs,o,u,s,c,l;if(h)this._showLabels(h.labels,kt.fromIProjectedRegionId(h.viewport),n),this._renderArgs=null;else{for(o=Object.keys(e),u=0,s=o.length;u<s;u++)f=e[o[u]],r=f.region,c=t.transform(r.anchor),r.anchor.x=c.x,r.anchor.y=c.y,r.anchorTransform=t.multiply(r.anchorTransform),this._renderers.forEach(function(n){n.update(f)});if(i===-1&&this._labelCollider.collide(e,n.pixelWidth),i===-1||i===1)for(u=0,s=o.length;u<s;u++)l=o[u],f=e[l],r=f.region,(r.isRejected||r.anchor.x<0||r.anchor.x>=n.pixelWidth||r.anchor.y<0||r.anchor.y>=n.pixelHeight)&&(this._renderers.forEach(function(n){n.remove(f)}),delete e[l])}this._viewport=n},n}();i.Labeler=w;i.LabelController=st;i.VectorLabels=lt}).call(window)